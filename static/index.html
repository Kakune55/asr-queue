<!DOCTYPE html>
<html>

<head>
    <title>ASRæœåŠ¡ç›‘æ§é¢æ¿</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* è®¾å¤‡ä¿¡æ¯æ ·å¼ */
        .device-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            margin-left: 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            white-space: nowrap;
            max-width: 400px;
        }

        .device-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
        }

        /* GPUå¾½ç« æ ·å¼ */
        .device-badge.gpu {
            background: linear-gradient(135deg, #76b900 0%, #5a9216 100%);
        }

        /* Intel CPUå¾½ç« æ ·å¼ */
        .device-badge.cpu, .device-badge.intel_cpu {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
        }

        /* AMD CPUå¾½ç« æ ·å¼ */
        .device-badge.amd_cpu {
            background: linear-gradient(135deg, #ed1c24 0%, #c5151c 100%);
        }

        /* æ ‡é¢˜å®¹å™¨ */
        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        /* ç»Ÿè®¡å¡ç‰‡æ ·å¼ */
        .statistics {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-card {
            flex: 1;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 200px;
        }

        /* é…ç½®åŒºåŸŸæ ·å¼ */
        #config-section {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        #config-section label {
            white-space: nowrap;
        }

        #max-queue-size {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #config-message {
            flex-basis: 100%;
            margin-top: 10px;
        }

        /* é˜Ÿåˆ—å¤§å°æ ·å¼ */
        #queue-size {
            color: var(--primary-color);
            font-size: 1.5em;
            font-weight: bold;
        }
    </style>
</head>


<body>
    <div id="dashboard" class="container">
        <div class="title-container">
            <h1>ASRæœåŠ¡ç›‘æ§é¢æ¿</h1>
            <!-- è®¾å¤‡ä¿¡æ¯å¾½ç«  -->
            <div id="device-badge" class="device-badge">
                <span id="device-badge-text">æ£€æµ‹ä¸­...</span>
            </div>
            <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
            <a href="/history.html" class="btn btn-secondary" style="margin-left: auto;">
                ğŸ“‹ æŸ¥çœ‹å†å²ä»»åŠ¡
            </a>
        </div>
        
        <h2>é˜Ÿåˆ—çŠ¶æ€</h2>
        <p>å½“å‰æ’é˜Ÿä»»åŠ¡æ•°: <strong id="queue-size">0</strong></p>
        
        <h2>ç³»ç»Ÿé…ç½®</h2>
        <div id="config-section">
            <label for="max-queue-size">é˜Ÿåˆ—æœ€å¤§å®¹é‡:</label>
            <input type="number" id="max-queue-size" min="1" value="10">
            <button id="update-config-btn" class="btn btn-primary">æ›´æ–°é…ç½®</button>
            <p id="config-message" style="display: none;"></p>
        </div>
        
        <h2>ç³»ç»Ÿç»Ÿè®¡</h2>
        <div id="statistics" class="statistics">
            <div class="stat-card">
                <h3>æœ€è¿‘5åˆ†é’Ÿ</h3>
                <p>å¹³å‡ç­‰å¾…: <span id="wait-5">0.00s</span></p>
                <p>å¹³å‡è´Ÿè½½: <span id="load-5">0%</span></p>
            </div>
            <div class="stat-card">
                <h3>æœ€è¿‘15åˆ†é’Ÿ</h3>
                <p>å¹³å‡ç­‰å¾…: <span id="wait-15">0.00s</span></p>
                <p>å¹³å‡è´Ÿè½½: <span id="load-15">0%</span></p>
            </div>
            <div class="stat-card">
                <h3>æœ€è¿‘45åˆ†é’Ÿ</h3>
                <p>å¹³å‡ç­‰å¾…: <span id="wait-45">0.00s</span></p>
                <p>å¹³å‡è´Ÿè½½: <span id="load-45">0%</span></p>
            </div>
        </div>
        <h3>å¾…å¤„ç†ä»»åŠ¡åˆ—è¡¨</h3>
        <table id="pending-tasks" class="table">
            <thead>
                <tr>
                    <th>ä»»åŠ¡ID</th>
                    <th>ä¼˜å…ˆçº§</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>æ­£åœ¨å¤„ç†ä¸­çš„ä»»åŠ¡</h2>
        <table id="processing-tasks" class="table">
            <thead>
                <tr>
                    <th>ä»»åŠ¡ID</th>
                    <th>ä¼˜å…ˆçº§</th>
                    <th>çŠ¶æ€</th>
                    <th>ç­‰å¾…æ—¶é—´</th>
                    <th>å¤„ç†æ—¶é—´</th>
                    <th>ç»“æœ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>æœ€è¿‘å¤„ç†ä»»åŠ¡</h2>
        <table id="recent-tasks" class="table">
            <thead>
                <tr>
                    <th>ä»»åŠ¡ID</th>
                    <th>ä¼˜å…ˆçº§</th>
                    <th>çŠ¶æ€</th>
                    <th>ç­‰å¾…æ—¶é—´</th>
                    <th>å¤„ç†æ—¶é—´</th>
                    <th>ç»“æœ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="task-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ä»»åŠ¡è¯¦æƒ…</h2>
                <button class="close">&times;</button>
            </div>
            <pre id="modal-task-details" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
    </div>

    <script>
        // è·å–å½“å‰é…ç½®
        async function fetchCurrentConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                document.getElementById('max-queue-size').value = config.max_queue_size;
            } catch (error) {
                console.error('è·å–å½“å‰é…ç½®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°é…ç½®
        async function updateConfig() {
            const maxQueueSize = document.getElementById('max-queue-size').value;
            const configMessageElement = document.getElementById('config-message');
            
            try {
                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        max_queue_size: parseInt(maxQueueSize)
                    })
                });
                
                if (response.ok) {
                    const updatedConfig = await response.json();
                    configMessageElement.textContent = `é…ç½®å·²æ›´æ–°ï¼Œæ–°çš„é˜Ÿåˆ—æœ€å¤§å®¹é‡ä¸º: ${updatedConfig.max_queue_size}`;
                    configMessageElement.style.color = 'green';
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('æ›´æ–°é…ç½®å¤±è´¥:', error);
                configMessageElement.textContent = 'æ›´æ–°é…ç½®å¤±è´¥: ' + error.message;
                configMessageElement.style.color = 'red';
            } finally {
                configMessageElement.style.display = 'block';
                // 3ç§’åéšè—æ¶ˆæ¯
                setTimeout(() => {
                    configMessageElement.style.display = 'none';
                }, 3000);
            }
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('update-config-btn').addEventListener('click', updateConfig);

        // é¡µé¢åŠ è½½æ—¶è·å–å½“å‰é…ç½®
        fetchCurrentConfig();

        const queueSizeElement = document.getElementById("queue-size");
        const pendingTasksListElement = document.getElementById("pending-tasks");
        const processingTasksListElement = document.getElementById("processing-tasks"); // æ–°å¢
        const recentTasksListElement = document.getElementById("recent-tasks");
        const modal = document.getElementById("task-details-modal");
        const modalDetailsElement = document.getElementById("modal-task-details");
        const closeModalButton = document.querySelector(".modal .close");

        // å…³é—­æ¨¡æ€æ¡†
        closeModalButton.onclick = function () { modal.style.display = "none"; }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        const ws = new WebSocket(`ws://${location.host}/ws/status`);

        ws.onopen = function (event) {
            console.log("æˆåŠŸè¿æ¥åˆ°æœåŠ¡å™¨WebSocketã€‚");
        };

        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);
            queueSizeElement.innerText = data.queue_size;

            // æ›´æ–°å¾…å¤„ç†ä»»åŠ¡åˆ—è¡¨
            // æ›´æ–°å¾…å¤„ç†ä»»åŠ¡åˆ—è¡¨
            pendingTasksListElement.querySelector('tbody').innerHTML = '';
            data.pending_tasks.forEach(function (task) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.priority}</td>
                `;
                pendingTasksListElement.querySelector('tbody').appendChild(tr);
            });

            // æ›´æ–°æ­£åœ¨å¤„ç†ä¸­çš„ä»»åŠ¡åˆ—è¡¨ (æ–°å¢)
            processingTasksListElement.querySelector('tbody').innerHTML = '';
            data.processing_tasks.forEach(function (task) {
                const tr = document.createElement("tr");
                let statusClass = 'status-processing'; // æ­£åœ¨å¤„ç†ä¸­çš„ä»»åŠ¡çŠ¶æ€å›ºå®šä¸ºprocessing
                
                tr.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.priority}</td>
                    <td><span class="task-status ${statusClass}">å¤„ç†ä¸­</span></td>
                    <td>${task.waiting_time ? task.waiting_time.toFixed(2) + 's' : 'N/A'}</td>
                    <td>${task.processing_time ? task.processing_time.toFixed(2) + 's' : 'N/A'}</td>
                    <td>${task.result_display || 'N/A'}</td>
                `;
                processingTasksListElement.querySelector('tbody').appendChild(tr);
            });

            // æ›´æ–°æœ€è¿‘å¤„ç†ä»»åŠ¡åˆ—è¡¨
            recentTasksListElement.querySelector('tbody').innerHTML = '';
            data.recent_tasks.forEach(function (task) {
                const tr = document.createElement("tr");
                let statusClass = '';
                if (task.status === 'completed') statusClass = 'status-completed';
                else if (task.status === 'failed') statusClass = 'status-failed';
                else if (task.status === 'pending') statusClass = 'status-pending';
                else if (task.status === 'processing') statusClass = 'status-processing';

                tr.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.priority}</td>
                    <td><span class="task-status ${statusClass}">${task.status === 'completed' ? 'å·²å®Œæˆ' : task.status === 'failed' ? 'å¤±è´¥' : task.status === 'pending' ? 'å¾…å¤„ç†' : 'å¤„ç†ä¸­'}</span></td>
                    <td>${task.waiting_time ? task.waiting_time.toFixed(2) + 's' : 'N/A'}</td>
                    <td>${task.processing_time ? task.processing_time.toFixed(2) + 's' : 'N/A'}</td>
                    <td><span class="details-button" data-task-id="${task.id}">${task.result_display}</span></td>
                `;
                recentTasksListElement.querySelector('tbody').appendChild(tr);
            });
        };

        // äº‹ä»¶å§”æ‰˜ï¼Œå¤„ç†æ‰€æœ‰â€œæŸ¥çœ‹è¯¦æƒ…â€æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
        recentTasksListElement.addEventListener('click', function (event) {
            if (event.target && event.target.matches('.details-button')) {
                const taskId = event.target.getAttribute('data-task-id');
                fetch(`/api/task/${taskId}`)
                    .then(response => response.json())
                    .then(taskDetails => {
                        modalDetailsElement.textContent = JSON.stringify(taskDetails, null, 2);
                        modal.style.display = "block";
                    })
                    .catch(error => console.error('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error));
            }
        });

        ws.onclose = function (event) {
            console.log("ä¸æœåŠ¡å™¨çš„WebSocketè¿æ¥å·²æ–­å¼€ï¼Œå°è¯•é‡æ–°è¿æ¥...");
            setTimeout(() => {
                // ç®€å•çš„é‡è¿é€»è¾‘
                window.location.reload();
            }, 3000);
        };

        ws.onerror = function (error) {
            console.error("WebSocket é”™è¯¯: ", error);
        };
        
        // å®šæœŸè·å–ç»Ÿè®¡æ•°æ®
        async function fetchStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const stats = await response.json();
                
                for (const [key, value] of Object.entries(stats)) {
                    const interval = key.split('_')[1];
                    document.getElementById(`wait-${interval}`).textContent =
                        `${value.avg_waiting_time}s`;
                    document.getElementById(`load-${interval}`).textContent =
                        `${value.avg_load_percent}%`;
                }
            } catch (error) {
                console.error('è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // è·å–è®¾å¤‡ä¿¡æ¯
        async function fetchDeviceInfo() {
            try {
                const response = await fetch('/api/device/info');
                const deviceInfo = await response.json();
                
                const deviceBadgeElement = document.getElementById('device-badge');
                const deviceBadgeTextElement = document.getElementById('device-badge-text');
                
                if (deviceInfo.error) {
                    deviceBadgeTextElement.textContent = 'è®¾å¤‡æ£€æµ‹å¤±è´¥';
                    return;
                }
                
                // æ„å»ºè®¾å¤‡ä¿¡æ¯æ–‡æœ¬
                let deviceText = deviceInfo.device_info;
                
                // æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
                deviceBadgeTextElement.textContent = deviceText;
                
                // æ ¹æ®è®¾å¤‡ç±»å‹è®¾ç½®å¾½ç« æ ·å¼
                // å³ä½¿åœ¨å¼ºåˆ¶CPUæ¨¡å¼ä¸‹ï¼Œå¦‚æœå®é™…ä½¿ç”¨çš„æ˜¯GPUï¼Œä»ç„¶æ˜¾ç¤ºGPUæ ·å¼
                if (deviceInfo.device_type === 'GPU') {
                    deviceBadgeElement.className = 'device-badge gpu';
                } else if (deviceInfo.device_type === 'AMD_CPU') {
                    deviceBadgeElement.className = 'device-badge amd_cpu';
                } else if (deviceInfo.device_type === 'INTEL_CPU') {
                    deviceBadgeElement.className = 'device-badge intel_cpu';
                } else {
                    deviceBadgeElement.className = 'device-badge cpu';
                }
            } catch (error) {
                console.error('è·å–è®¾å¤‡ä¿¡æ¯å¤±è´¥:', error);
                document.getElementById('device-badge-text').textContent = 'æ£€æµ‹å¤±è´¥';
            }
        }

        // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
        setInterval(fetchStatistics, 30000);
        fetchStatistics(); // åˆå§‹åŠ è½½
        
        // è·å–è®¾å¤‡ä¿¡æ¯ï¼ˆåªéœ€è¦è·å–ä¸€æ¬¡ï¼‰
        fetchDeviceInfo();
    </script>
</body>

</html>