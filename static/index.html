<!DOCTYPE html>
<html>

<head>
    <title>ASR服务监控面板</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        /* 设备信息样式 */
        .device-badge {
            display: inline-flex;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            margin-left: 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            white-space: nowrap;
            max-width: 400px;
        }

        .device-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
        }

        /* GPU徽章样式 */
        .device-badge.gpu {
            background: linear-gradient(135deg, #76b900 0%, #5a9216 100%);
        }

        /* Intel CPU徽章样式 */
        .device-badge.cpu, .device-badge.intel_cpu {
            background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
        }

        /* AMD CPU徽章样式 */
        .device-badge.amd_cpu {
            background: linear-gradient(135deg, #ed1c24 0%, #c5151c 100%);
        }

        /* 标题容器 */
        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        /* 统计卡片样式 */
        .statistics {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-card {
            flex: 1;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 200px;
        }

        /* 配置区域样式 */
        #config-section {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        #config-section label {
            white-space: nowrap;
        }

        #max-queue-size {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        #config-message {
            flex-basis: 100%;
            margin-top: 10px;
        }

        /* 队列大小样式 */
        #queue-size {
            color: var(--primary-color);
            font-size: 1.5em;
            font-weight: bold;
        }
    </style>
</head>


<body>
    <div id="dashboard" class="container">
        <div class="title-container">
            <h1>ASR服务监控面板</h1>
            <!-- 设备信息徽章 -->
            <div id="device-badge" class="device-badge">
                <span id="device-badge-text">检测中...</span>
            </div>
            <!-- 操作按钮区域 -->
            <a href="/history.html" class="btn btn-secondary" style="margin-left: auto;">
                📋 查看历史任务
            </a>
        </div>
        
        <h2>队列状态</h2>
        <p>当前排队任务数: <strong id="queue-size">0</strong></p>
        
        <h2>系统配置</h2>
        <div id="config-section">
            <label for="max-queue-size">队列最大容量:</label>
            <input type="number" id="max-queue-size" min="1" value="10">
            <button id="update-config-btn" class="btn btn-primary">更新配置</button>
            <p id="config-message" style="display: none;"></p>
        </div>
        
        <h2>系统统计</h2>
        <div id="statistics" class="statistics">
            <div class="stat-card">
                <h3>最近5分钟</h3>
                <p>平均等待: <span id="wait-5">0.00s</span></p>
                <p>平均负载: <span id="load-5">0%</span></p>
            </div>
            <div class="stat-card">
                <h3>最近15分钟</h3>
                <p>平均等待: <span id="wait-15">0.00s</span></p>
                <p>平均负载: <span id="load-15">0%</span></p>
            </div>
            <div class="stat-card">
                <h3>最近45分钟</h3>
                <p>平均等待: <span id="wait-45">0.00s</span></p>
                <p>平均负载: <span id="load-45">0%</span></p>
            </div>
        </div>
        <h3>待处理任务列表</h3>
        <table id="pending-tasks" class="table">
            <thead>
                <tr>
                    <th>任务ID</th>
                    <th>优先级</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>正在处理中的任务</h2>
        <table id="processing-tasks" class="table">
            <thead>
                <tr>
                    <th>任务ID</th>
                    <th>优先级</th>
                    <th>状态</th>
                    <th>等待时间</th>
                    <th>处理时间</th>
                    <th>结果</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h2>最近处理任务</h2>
        <table id="recent-tasks" class="table">
            <thead>
                <tr>
                    <th>任务ID</th>
                    <th>优先级</th>
                    <th>状态</th>
                    <th>等待时间</th>
                    <th>处理时间</th>
                    <th>结果</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- 任务详情模态框 -->
    <div id="task-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">任务详情</h2>
                <button class="close">&times;</button>
            </div>
            <pre id="modal-task-details" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
    </div>

    <script>
        // 获取当前配置
        async function fetchCurrentConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                document.getElementById('max-queue-size').value = config.max_queue_size;
            } catch (error) {
                console.error('获取当前配置失败:', error);
            }
        }

        // 更新配置
        async function updateConfig() {
            const maxQueueSize = document.getElementById('max-queue-size').value;
            const configMessageElement = document.getElementById('config-message');
            
            try {
                const response = await fetch('/api/config', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        max_queue_size: parseInt(maxQueueSize)
                    })
                });
                
                if (response.ok) {
                    const updatedConfig = await response.json();
                    configMessageElement.textContent = `配置已更新，新的队列最大容量为: ${updatedConfig.max_queue_size}`;
                    configMessageElement.style.color = 'green';
                } else {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('更新配置失败:', error);
                configMessageElement.textContent = '更新配置失败: ' + error.message;
                configMessageElement.style.color = 'red';
            } finally {
                configMessageElement.style.display = 'block';
                // 3秒后隐藏消息
                setTimeout(() => {
                    configMessageElement.style.display = 'none';
                }, 3000);
            }
        }

        // 绑定事件
        document.getElementById('update-config-btn').addEventListener('click', updateConfig);

        // 页面加载时获取当前配置
        fetchCurrentConfig();

        const queueSizeElement = document.getElementById("queue-size");
        const pendingTasksListElement = document.getElementById("pending-tasks");
        const processingTasksListElement = document.getElementById("processing-tasks"); // 新增
        const recentTasksListElement = document.getElementById("recent-tasks");
        const modal = document.getElementById("task-details-modal");
        const modalDetailsElement = document.getElementById("modal-task-details");
        const closeModalButton = document.querySelector(".modal .close");

        // 关闭模态框
        closeModalButton.onclick = function () { modal.style.display = "none"; }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        const ws = new WebSocket(`ws://${location.host}/ws/status`);

        ws.onopen = function (event) {
            console.log("成功连接到服务器WebSocket。");
        };

        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);
            queueSizeElement.innerText = data.queue_size;

            // 更新待处理任务列表
            // 更新待处理任务列表
            pendingTasksListElement.querySelector('tbody').innerHTML = '';
            data.pending_tasks.forEach(function (task) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.priority}</td>
                `;
                pendingTasksListElement.querySelector('tbody').appendChild(tr);
            });

            // 更新正在处理中的任务列表 (新增)
            processingTasksListElement.querySelector('tbody').innerHTML = '';
            data.processing_tasks.forEach(function (task) {
                const tr = document.createElement("tr");
                let statusClass = 'status-processing'; // 正在处理中的任务状态固定为processing
                
                tr.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.priority}</td>
                    <td><span class="task-status ${statusClass}">处理中</span></td>
                    <td>${task.waiting_time ? task.waiting_time.toFixed(2) + 's' : 'N/A'}</td>
                    <td>${task.processing_time ? task.processing_time.toFixed(2) + 's' : 'N/A'}</td>
                    <td>${task.result_display || 'N/A'}</td>
                `;
                processingTasksListElement.querySelector('tbody').appendChild(tr);
            });

            // 更新最近处理任务列表
            recentTasksListElement.querySelector('tbody').innerHTML = '';
            data.recent_tasks.forEach(function (task) {
                const tr = document.createElement("tr");
                let statusClass = '';
                if (task.status === 'completed') statusClass = 'status-completed';
                else if (task.status === 'failed') statusClass = 'status-failed';
                else if (task.status === 'pending') statusClass = 'status-pending';
                else if (task.status === 'processing') statusClass = 'status-processing';

                tr.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.priority}</td>
                    <td><span class="task-status ${statusClass}">${task.status === 'completed' ? '已完成' : task.status === 'failed' ? '失败' : task.status === 'pending' ? '待处理' : '处理中'}</span></td>
                    <td>${task.waiting_time ? task.waiting_time.toFixed(2) + 's' : 'N/A'}</td>
                    <td>${task.processing_time ? task.processing_time.toFixed(2) + 's' : 'N/A'}</td>
                    <td><span class="details-button" data-task-id="${task.id}">${task.result_display}</span></td>
                `;
                recentTasksListElement.querySelector('tbody').appendChild(tr);
            });
        };

        // 事件委托，处理所有“查看详情”按钮的点击事件
        recentTasksListElement.addEventListener('click', function (event) {
            if (event.target && event.target.matches('.details-button')) {
                const taskId = event.target.getAttribute('data-task-id');
                fetch(`/api/task/${taskId}`)
                    .then(response => response.json())
                    .then(taskDetails => {
                        modalDetailsElement.textContent = JSON.stringify(taskDetails, null, 2);
                        modal.style.display = "block";
                    })
                    .catch(error => console.error('获取任务详情失败:', error));
            }
        });

        ws.onclose = function (event) {
            console.log("与服务器的WebSocket连接已断开，尝试重新连接...");
            setTimeout(() => {
                // 简单的重连逻辑
                window.location.reload();
            }, 3000);
        };

        ws.onerror = function (error) {
            console.error("WebSocket 错误: ", error);
        };
        
        // 定期获取统计数据
        async function fetchStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const stats = await response.json();
                
                for (const [key, value] of Object.entries(stats)) {
                    const interval = key.split('_')[1];
                    document.getElementById(`wait-${interval}`).textContent =
                        `${value.avg_waiting_time}s`;
                    document.getElementById(`load-${interval}`).textContent =
                        `${value.avg_load_percent}%`;
                }
            } catch (error) {
                console.error('获取统计数据失败:', error);
            }
        }

        // 获取设备信息
        async function fetchDeviceInfo() {
            try {
                const response = await fetch('/api/device/info');
                const deviceInfo = await response.json();
                
                const deviceBadgeElement = document.getElementById('device-badge');
                const deviceBadgeTextElement = document.getElementById('device-badge-text');
                
                if (deviceInfo.error) {
                    deviceBadgeTextElement.textContent = '设备检测失败';
                    return;
                }
                
                // 构建设备信息文本
                let deviceText = deviceInfo.device_info;
                
                // 显示设备信息
                deviceBadgeTextElement.textContent = deviceText;
                
                // 根据设备类型设置徽章样式
                // 即使在强制CPU模式下，如果实际使用的是GPU，仍然显示GPU样式
                if (deviceInfo.device_type === 'GPU') {
                    deviceBadgeElement.className = 'device-badge gpu';
                } else if (deviceInfo.device_type === 'AMD_CPU') {
                    deviceBadgeElement.className = 'device-badge amd_cpu';
                } else if (deviceInfo.device_type === 'INTEL_CPU') {
                    deviceBadgeElement.className = 'device-badge intel_cpu';
                } else {
                    deviceBadgeElement.className = 'device-badge cpu';
                }
            } catch (error) {
                console.error('获取设备信息失败:', error);
                document.getElementById('device-badge-text').textContent = '检测失败';
            }
        }

        // 每30秒更新一次
        setInterval(fetchStatistics, 30000);
        fetchStatistics(); // 初始加载
        
        // 获取设备信息（只需要获取一次）
        fetchDeviceInfo();
    </script>
</body>

</html>