<!DOCTYPE html>
<html>

<head>
    <title>ASR服务 - 历史任务</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .container {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        /* 标题容器 */
        .title-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 15px;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f8f8;
            border-radius: var(--border-radius-sm);
            flex-wrap: wrap;
        }

        .controls > div {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .controls select {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
        }

        .task-id {
            font-family: monospace;
            font-size: 12px;
        }

        .time-cell {
            font-size: 12px;
            white-space: nowrap;
        }

        .details-button {
            cursor: pointer;
            color: var(--primary-color);
            text-decoration: underline;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }

        .details-button:hover {
            color: var(--primary-hover);
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .controls > div {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="title-container">
            <h1>历史任务记录</h1>
            <a href="/" class="btn btn-secondary" style="margin-left: auto;">返回仪表盘</a>
        </div>

        <div class="controls">
            <div>
                <label for="status-filter">状态筛选:</label>
                <select id="status-filter">
                    <option value="all">全部</option>
                    <option value="completed">已完成</option>
                    <option value="failed">失败</option>
                </select>
            </div>
            
            <div>
                <label for="page-size">每页显示:</label>
                <select id="page-size">
                    <option value="10">10条</option>
                    <option value="20">20条</option>
                    <option value="50" selected>50条</option>
                    <option value="100">100条</option>
                </select>
            </div>
            
            <button class="btn btn-success" onclick="loadTasks()">刷新</button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            正在加载任务数据...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="pagination-info">
                <span id="pagination-info-text"></span>
            </div>

            <table id="tasks-table" class="table">
                <thead>
                    <tr>
                        <th style="width: 120px;">任务ID</th>
                        <th style="width: 60px;">优先级</th>
                        <th style="width: 80px;">状态</th>
                        <th style="width: 140px;">创建时间</th>
                        <th style="width: 140px;">完成时间</th>
                        <th style="width: 80px;">等待时间</th>
                        <th style="width: 80px;">处理时间</th>
                        <th>识别结果</th>
                    </tr>
                </thead>
                <tbody id="tasks-tbody">
                </tbody>
            </table>

            <div class="pagination" id="pagination">
            </div>
        </div>
    </div>

    <!-- 任务详情模态框 -->
    <div id="task-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">任务详情</h2>
                <button class="close">&times;</button>
            </div>
            <pre id="modal-task-details" style="white-space: pre-wrap; word-wrap: break-word;"></pre>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentStatus = 'all';
        let currentPageSize = 50;
        let currentData = null;

        // 模态框控制
        const modal = document.getElementById("task-details-modal");
        const modalDetailsElement = document.getElementById("modal-task-details");
        const closeModalButton = document.querySelector(".modal .close");

        closeModalButton.onclick = function () { modal.style.display = "none"; }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // 格式化时间
        function formatDateTime(dateStr) {
            if (!dateStr) return 'N/A';
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 格式化时长
        function formatDuration(seconds) {
            if (seconds === null || seconds === undefined) return 'N/A';
            if (seconds < 1) return `${(seconds * 1000).toFixed(0)}ms`;
            return `${seconds.toFixed(2)}s`;
        }

        // 截取并格式化结果文本
        function formatResult(result) {
            if (!result) return 'N/A';
            const maxLength = 100;
            if (result.length > maxLength) {
                return result.substring(0, maxLength) + '...';
            }
            return result;
        }

        // 获取任务详情
        async function showTaskDetails(taskId) {
            try {
                const response = await fetch(`/api/task/${taskId}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const taskDetails = await response.json();
                modalDetailsElement.textContent = JSON.stringify(taskDetails, null, 2);
                modal.style.display = "block";
            } catch (error) {
                console.error('获取任务详情失败:', error);
                alert('获取任务详情失败: ' + error.message);
            }
        }

        // 加载任务数据
        async function loadTasks(page = 1) {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            const contentElement = document.getElementById('content');

            // 显示加载状态
            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';
            contentElement.style.display = 'none';

            try {
                const url = `/api/history?page=${page}&page_size=${currentPageSize}&status=${currentStatus}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                currentData = data;
                currentPage = page;

                // 渲染任务表格
                renderTasksTable(data.tasks);
                
                // 渲染分页控件
                renderPagination(data);
                
                // 更新分页信息
                updatePaginationInfo(data);

                // 显示内容
                loadingElement.style.display = 'none';
                contentElement.style.display = 'block';

            } catch (error) {
                console.error('加载任务失败:', error);
                loadingElement.style.display = 'none';
                errorElement.textContent = '加载任务失败: ' + error.message;
                errorElement.style.display = 'block';
            }
        }

        // 渲染任务表格
        function renderTasksTable(tasks) {
            const tbody = document.getElementById('tasks-tbody');
            tbody.innerHTML = '';

            if (tasks.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = '<td colspan="8" style="text-align: center; color: #666;">暂无数据</td>';
                tbody.appendChild(tr);
                return;
            }

            tasks.forEach(task => {
                const tr = document.createElement('tr');
                
                const statusClass = task.status === 'completed' ? 'status-completed' : 'status-failed';
                const resultDisplay = formatResult(task.result || '');
                
                tr.innerHTML = `
                    <td class="task-id">${task.id}</td>
                    <td>${task.priority}</td>
                    <td><span class="task-status ${statusClass}">${task.status === 'completed' ? '已完成' : '失败'}</span></td>
                    <td class="time-cell">${formatDateTime(task.created_at)}</td>
                    <td class="time-cell">${formatDateTime(task.updated_at)}</td>
                    <td>${formatDuration(task.waiting_time)}</td>
                    <td>${formatDuration(task.processing_time)}</td>
                    <td><span class="details-button" onclick="showTaskDetails('${task.id}')">${resultDisplay}</span></td>
                `;
                
                tbody.appendChild(tr);
            });
        }

        // 渲染分页控件
        function renderPagination(data) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            const totalPages = data.total_pages;
            if (totalPages <= 1) return;

            // 首页按钮
            const firstBtn = document.createElement('button');
            firstBtn.textContent = '首页';
            firstBtn.onclick = () => loadTasks(1);
            firstBtn.disabled = currentPage === 1;
            pagination.appendChild(firstBtn);

            // 上一页按钮
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '上一页';
            prevBtn.disabled = !data.has_prev;
            prevBtn.onclick = () => loadTasks(currentPage - 1);
            pagination.appendChild(prevBtn);

            // ... 省略号
            if (currentPage > 3) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'pagination-ellipsis';
                pagination.appendChild(ellipsis);
            }

            // 页码按钮
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.onclick = () => loadTasks(i);

                if (i === currentPage) {
                    pageBtn.classList.add('current-page');
                }

                pagination.appendChild(pageBtn);
            }
            
            // ... 省略号
            if (currentPage < totalPages - 2) {
                const ellipsis = document.createElement('span');
                ellipsis.textContent = '...';
                ellipsis.className = 'pagination-ellipsis';
                pagination.appendChild(ellipsis);
            }

            // 下一页按钮
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '下一页';
            nextBtn.disabled = !data.has_next;
            nextBtn.onclick = () => loadTasks(currentPage + 1);
            pagination.appendChild(nextBtn);
            
            // 尾页按钮
            const lastBtn = document.createElement('button');
            lastBtn.textContent = '尾页';
            lastBtn.onclick = () => loadTasks(totalPages);
            lastBtn.disabled = currentPage === totalPages;
            pagination.appendChild(lastBtn);

            // 跳转区域
            const jumpContainer = document.createElement('div');
            jumpContainer.className = 'pagination-jump';

            const jumpInput = document.createElement('input');
            jumpInput.type = 'number';
            jumpInput.id = 'jump-to-page';
            jumpInput.min = '1';
            jumpInput.max = totalPages;
            jumpInput.value = currentPage;

            const jumpButton = document.createElement('button');
            jumpButton.textContent = '跳转';
            jumpButton.onclick = () => {
                const page = parseInt(jumpInput.value);
                if (page >= 1 && page <= totalPages) {
                    loadTasks(page);
                } else {
                    alert(`请输入 1 到 ${totalPages} 之间的有效页码`);
                }
            };
            
            jumpInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    jumpButton.click();
                }
            });

            const textBefore = document.createElement('span');
            textBefore.textContent = '跳转到';
            jumpContainer.appendChild(textBefore);

            jumpContainer.appendChild(jumpInput);

            const textAfter = document.createElement('span');
            textAfter.textContent = '页';
            jumpContainer.appendChild(textAfter);
            
            jumpContainer.appendChild(jumpButton);
            
            pagination.appendChild(jumpContainer);
        }

        // 更新分页信息
        function updatePaginationInfo(data) {
            const infoElement = document.getElementById('pagination-info-text');
            const start = (data.current_page - 1) * data.page_size + 1;
            const end = Math.min(data.current_page * data.page_size, data.total_count);
            infoElement.textContent = `显示第 ${start}-${end} 条，共 ${data.total_count} 条记录`;
        }

        // 事件监听器
        document.getElementById('status-filter').addEventListener('change', function() {
            currentStatus = this.value;
            currentPage = 1;
            loadTasks(1);
        });

        document.getElementById('page-size').addEventListener('change', function() {
            currentPageSize = parseInt(this.value);
            currentPage = 1;
            loadTasks(1);
        });

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadTasks(1);
        });
    </script>
</body>

</html>
